// Code generated by queryx, DO NOT EDIT.

package db

import (
	"context"
	"database/sql"
	"fmt"
	"log"
	"os"

	"github.com/efectn/go-orm-benchmarks/bench/queryx/db/queryx"
)

type Queries interface {
	QueryModel() *ModelQuery
}

type QXClient struct {
	db     *sql.DB
	config *queryx.Config
	logger queryx.Logger
	*queryx.Adapter
	*queryx.Schema
}

func NewClient() (*QXClient, error) {
	env := os.Getenv("QUERYX_ENV")
	if env == "" {
		env = "development"
	}
	return NewClientWithEnv(env)
}

func NewClientWithEnv(env string) (*QXClient, error) {
	config := queryx.NewConfig(env)
	if config == nil {
		return nil, fmt.Errorf("client config is missing for %s", env)
	}
	db, err := sql.Open("postgres", config.URL)
	if err != nil {
		return nil, err
	}

	client := &QXClient{
		db:      db,
		config:  config,
		Adapter: queryx.NewAdapter(db),
		Schema:  queryx.NewSchema(),
	}
	client.setDefaultLogger()

	return client, nil
}

func (c *QXClient) SetLogger(logger queryx.Logger) {
	c.logger = logger
}

func (c *QXClient) setDefaultLogger() {
	c.logger = log.New(os.Stderr, "sql ", log.Llongfile|log.LstdFlags)
}

func (c *QXClient) QueryModel() *ModelQuery {
	return NewModelQuery(c.Adapter, c.Schema, c)
}

func (c *QXClient) Transaction(f func(t *Tx) error) error {
	tx, err := c.Tx()
	if err != nil {
		return err
	}
	defer tx.Rollback()
	if err = f(tx); err != nil {
		return err
	}
	return tx.Commit()
}

func (c *QXClient) Raw(fragment string, args ...interface{}) *queryx.Clause {
	return queryx.NewClause(fragment, args)
}

type Tx struct {
	*queryx.Schema
	*queryx.Adapter
	tx     *sql.Tx
	client *QXClient
}

func (c *QXClient) Tx() (*Tx, error) {
	ctx := context.Background()
	tx, err := c.db.BeginTx(ctx, nil)
	if err != nil {
		return nil, err
	}

	return &Tx{
		tx:      tx,
		Schema:  c.Schema,
		Adapter: queryx.NewAdapter(tx),
		client:  c,
	}, nil
}

func (tx *Tx) Commit() error {
	return tx.tx.Commit()
}

func (tx *Tx) Rollback() error {
	return tx.tx.Rollback()
}

func (tx *Tx) QueryModel() *ModelQuery {
	return NewModelQuery(tx.Adapter, tx.Schema, tx)
}

func (tx *Tx) Raw(fragment string, args ...interface{}) *queryx.Clause {
	return queryx.NewClause(fragment, args)
}
